<!DOCTYPE html>
<html lang="he" dir="rtl" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<head th:replace="~{fragments/header :: header}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{fragments/header :: navigation}"></nav>

<main class="flex-grow-1">
  <section class="container py-5 mt-4">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <h2 class="fw-bold mb-0">פרטי מועמדות</h2>
      <a th:href="@{/positions/{id}(id=${app.position.id})}" class="btn btn-secondary rounded-3">
        <i class="bi bi-arrow-right me-2"></i>חזרה
      </a>
    </div>

    <div class="card shadow-sm rounded-4 mb-4">
      <div class="card-header bg-white rounded-top-4 border-bottom-0">
        <h5 class="mb-0">פרטי משרה</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6"><strong>תפקיד:</strong> <span th:text="${app.position.jobTitle}"></span></div>
          <div class="col-md-6"><strong>מיקום:</strong> <span th:text="${app.position.location}"></span></div>
          <div class="col-md-6"><strong>סוג שירות:</strong> <span th:text="${app.position.assignmentType}"></span></div>
          <div class="col-md-6"><strong>דרישות:</strong> <span th:text="${app.position.requirements}"></span></div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 mb-4">
      <div class="card-header bg-white rounded-top-4 border-bottom-0">
        <h5 class="mb-0">פרטי מועמד</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6"><strong>שם מלא:</strong> <span th:text="${app.applicant.firstName + ' ' + app.applicant.lastName}"></span></div>
          <div class="col-md-6"><strong>אימייל:</strong> <span th:text="${app.applicant.email}"></span></div>
          <div class="col-md-6"><strong>על המועמד:</strong> <span th:text="${app.applicant.about}"></span></div>
          <div class="col-md-6"><strong>תאריך הגשה:</strong> <span th:text="${#temporals.format(app.applicationDate, 'dd/MM/yyyy HH:mm')}"></span></div>
          <div class="col-md-6">
            <strong>סטטוס מועמדות:</strong>
            <span class="badge ms-2"
                  th:classappend="${app.status.name() == 'PENDING' ? 'bg-warning' :
                                 (app.status.name() == 'APPROVED' ? 'bg-success' :
                                 (app.status.name() == 'REJECTED' ? 'bg-danger' : 'bg-secondary'))}"
                  th:text="${app.status.name() == 'PENDING' ? 'ממתין להחלטה' :
                           (app.status.name() == 'APPROVED' ? 'התקבל' :
                           (app.status.name() == 'REJECTED' ? 'נדחה' : 'בוטל'))}">
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm rounded-4 mb-4"
         th:classappend="${app.status.name() != 'PENDING' ? 'd-none' : ''}">
      <div class="card-header bg-white rounded-top-4 border-bottom-0">
        <h5 class="mb-0">פעולות על מועמדות</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">

          <form class="col-md-6 d-flex align-items-end approve-application-form" th:attr="data-application-id=${app.id}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-outline-success w-100">קבל מועמדות</button>
          </form>

          <form class="col-md-6 d-flex align-items-end reject-application-form" th:attr="data-application-id=${app.id}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="btn btn-outline-danger w-100">דחה מועמדות</button>
          </form>

          <form th:action="@{/interviews/schedule}" method="post" class="col-12 row g-3 align-items-center" id="scheduleInterviewForm">
            <input type="hidden" name="applicationId" th:value="${app.id}" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <h5 class="mb-0">תיאום ראיון</h5>

            <div class="col-md-6">
              <label class="form-label">סוג הפגישה</label>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="meetingTypeSwitch" name="isVirtual" />
                <label class="form-check-label" for="meetingTypeSwitch">פגישה מקוונת</label>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">תאריך ושעה</label>
              <input type="datetime-local" name="interviewDate" id="interviewDate" class="form-control" min="" />
              <div class="invalid-feedback" id="interviewDate-error"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label" id="locationLabel">מיקום</label>
              <input type="text" name="location" id="locationInput" class="form-control" placeholder="מיקום פיזי" />
              <div class="invalid-feedback" id="locationInput-error"></div>
            </div>

            <div class="col-md-6">
              <label class="form-label">הערות</label>
              <input type="text" name="notes" class="form-control" placeholder="הערות (אופציונלי)" />
            </div>

            <div class="col-12 mt-3">
              <button type="submit" class="btn btn-primary w-100">קבע ראיון</button>
            </div>
          </form>

        </div>
      </div>
    </div>

    <div th:if="${interviews != null && !#lists.isEmpty(interviews)}" class="card shadow-sm rounded-4">
      <div class="card-header bg-white rounded-top-4 border-bottom-0">
        <h5 class="mb-0">ראיונות שנקבעו</h5>
      </div>
      <div class="card-body">
        <table class="table table-bordered text-center align-middle" id="interviews-table">
          <thead class="table-light">
          <tr>
            <th>תאריך
              <button class="btn ms-1 p-0"
                      data-sort="date"
                      data-table="interviews-table"
                      data-col="0"
                      data-action="sort">
                <i class="bi bi-arrow-down-up"></i>
              </button>
            </th>
            <th>שעה</th>
            <th>מיקום/לינק</th>
            <th>סטטוס</th>
            <th>הערות</th>
            <th>סיכום ראיון</th>
            <th>פעולות</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="interview : ${interviews}">
            <td th:text="${#temporals.format(interview.interviewDate, 'dd/MM/yyyy')}"></td>
            <td th:text="${#temporals.format(interview.interviewDate, 'HH:mm')}"></td>
            <td>
              <div th:if="${interview.isVirtual != null && interview.isVirtual}" class="text-center">
                <a th:href="${interview.jitsiLink}" target="_blank" 
                   class="btn btn-sm btn-primary">
                  <i class="bi bi-camera-video"></i> הצטרף לפגישה
                </a>
              </div>
              <span th:if="${interview.isVirtual == null || !interview.isVirtual}" 
                    th:text="${interview.location}"></span>
            </td>
            <td>
              <span class="badge"
                    th:classappend="${interview.status.name() == 'SCHEDULED' ? 'bg-warning' :
                                     (interview.status.name() == 'CONFIRMED' ? 'bg-success' :
                                     (interview.status.name() == 'REJECTED' ? 'bg-danger' :
                                     (interview.status.name() == 'COMPLETED' ? 'bg-primary' : 'bg-secondary')))}"
                    th:text="${interview.status.name() == 'SCHEDULED' ? 'ממתין לאישור' :
                             (interview.status.name() == 'CONFIRMED' ? 'מאושר' :
                             (interview.status.name() == 'REJECTED' ? 'נדחה' :
                             (interview.status.name() == 'COMPLETED' ? 'הושלם' : 'מבוטל')))}">
              </span>
              <div th:if="${interview.status.name() == 'REJECTED' && interview.rejectionReason != null && !#strings.isEmpty(interview.rejectionReason)}"
                   class="mt-1">
                <small class="text-muted">
                  <strong>סיבה:</strong> <span th:text="${interview.rejectionReason}"></span>
                </small>
              </div>

            </td>
            <td th:text="${interview.notes}"></td>
            <td>
              <div th:if="${interview.interviewSummary != null && !interview.interviewSummary.isEmpty()}">
                <span th:text="${interview.interviewSummary}"></span>
              </div>
              <form th:if="${interview.status.name() != 'CANCELED'}" class="mt-2 update-summary-form" th:attr="data-interview-id=${interview.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="input-group input-group-sm">
                  <textarea name="summary" class="form-control form-control-sm" rows="2" 
                            th:placeholder="'כתוב סיכום ראיון...'" 
                            th:text="${interview.interviewSummary}"></textarea>
                  <button type="submit" class="btn btn-outline-primary btn-sm">שמור</button>
                </div>
              </form>
            </td>
            <td>
              <div class="d-flex flex-column ms-1 d-inline-flex">
                <button type="button"
                        class="btn btn-outline-secondary btn-sm mb-1 edit-interview-btn"
                        th:data-id="${interview.id}" 
                        th:data-date="${#temporals.format(interview.interviewDate, 'yyyy-MM-dd''T''HH:mm')}" 
                        th:data-location="${interview.location}" 
                        th:data-notes="${interview.notes != null ? interview.notes : ''}"
                        th:data-virtual="${interview.isVirtual != null ? interview.isVirtual : false}"
                        th:classappend="${app.status.name() == 'REJECTED' or app.status.name() == 'CANCELED' ? 'd-none' : ''}">
                  <i class="bi bi-pencil"></i> ערוך
                </button>
                
                <form th:action="@{'/interviews/' + ${interview.id} + '/cancel'}" method="post" 
                      th:if="${interview.status.name() != 'CANCELED' && interview.status.name() != 'COMPLETED'}" 
                      class="d-inline cancel-interview-form">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <button type="submit" class="btn btn-outline-danger btn-sm mb-1">
                    <i class="bi bi-x-circle"></i> בטל
                  </button>
                </form>
                
                <form th:if="${interview.status.name() == 'CONFIRMED'}" class="d-inline complete-interview-form" th:attr="data-interview-id=${interview.id}">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <button type="submit" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-check-circle"></i> הושלם
                  </button>
                </form>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="editInterviewModal" tabindex="-1" aria-labelledby="editInterviewModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editInterviewModalLabel">עריכת ראיון</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="editInterviewForm" method="post">
            <div class="modal-body">
              <input type="hidden" name="applicationId" th:value="${app.id}" />
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              
              <div class="mb-3">
                <label class="form-label">סוג הפגישה</label>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="editMeetingTypeSwitch" name="isVirtual" />
                  <label class="form-check-label" for="editMeetingTypeSwitch">פגישה מקוונת</label>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">תאריך ושעה</label>
                <input type="datetime-local" name="interviewDate" id="editInterviewDate" class="form-control" min="" />
                <div class="invalid-feedback" id="editInterviewDate-error"></div>
              </div>
              
              <div class="mb-3">
                <label class="form-label" id="editLocationLabel">מיקום</label>
                <input type="text" name="location" id="editLocationInput" class="form-control" placeholder="מיקום פיזי" />
                <div class="invalid-feedback" id="editLocationInput-error"></div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">הערות</label>
                <input type="text" name="notes" id="editInterviewNotes" class="form-control" placeholder="הערות (אופציונלי)" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
              <button type="submit" class="btn btn-primary">שמור שינויים</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </section>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>
<div th:replace="~{fragments/toasts :: toast}"></div>
<script type="module" th:src="@{/js/toastUtils.js}"></script>
<script type="module" th:src="@{/js/interviewForm.js}"></script>
<script type="module" th:src="@{/js/interviewsSort.js}"></script>
<script type="module" th:src="@{/js/application-details.js}"></script>
</body>
</html>