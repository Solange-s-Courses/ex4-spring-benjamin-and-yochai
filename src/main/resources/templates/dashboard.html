<!DOCTYPE html>
<html lang="he" dir="rtl" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: header}"></head>
<body class="d-flex flex-column min-vh-100">
<!-- Navigation -->
<nav th:replace="~{fragments/header :: navigation}"></nav>

<!-- Main Dashboard Section -->
<main class="flex-grow-1">
    <section class="container py-5 mt-4">
        <!-- Welcome -->
        <div class="mb-4 mt-4 d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">שלום <span sec:authentication="principal.firstName"></span>!</h2>
        </div>
        <!-- Statistics -->
        <div class="row mb-5 text-center">
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>סה"כ משרות שהוגשו</h5>
                    <p class="fs-4 fw-bold text-primary" th:text="${totalApplications}">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>ממתינות לקביעת ראיון</h5>
                    <p class="fs-4 fw-bold text-warning" th:text="${pendingApplications}">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>ראיונות קרובים</h5>
                    <p class="fs-4 fw-bold text-success" th:text="${upcomingInterviewCount}">0</p>
                </div>
            </div>
        </div>

        <!-- my positions -->
        <div sec:authorize="hasAnyRole('ADMIN', 'COMMANDER')" class="mb-5">
            <h4 class="mb-3">המשרות שפרסמת</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>שם משרה</th>
                        <th>מיקום</th>
                        <th>סוג</th>
                        <th>סטטוס</th>
                        <th>הגשות פעילות</th>
                        <th>פעולות</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(myPositions)}">
                        <td colspan="6">לא נמצאו משרות שפרסמת</td>
                    </tr>
                    <tr th:each="position : ${myPositions}">
                        <td>
                            <a th:href="@{'/positions/' + ${position.id}}"
                               th:text="${position.jobTitle}"
                               class="text-decoration-none">
                            </a>
                        </td>
                        <td th:text="${position.location}"></td>
                        <td th:text="${position.assignmentType}"></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${position.status.name() == 'ACTIVE' ? 'bg-success' :
                                  (position.status.name() == 'CANCELED' ? 'bg-danger' :
                                  (position.status.name() == 'FULFILLED' ? 'bg-primary' :
                                  (position.status.name() == 'FROZEN' ? 'bg-secondary' : 'bg-light')))}"
                                  th:text="${position.status.name() == 'ACTIVE' ? 'פעילה' :
                                  (position.status.name() == 'CANCELED' ? 'מבוטלת' :
                                  (position.status.name() == 'FULFILLED' ? 'אוישה' :
                                  (position.status.name() == 'FROZEN' ? 'מוקפאת' : position.status.name())))}">
                            </span>
                        </td>
                        <td>--</td>
                        <td>
                            <div class="d-flex flex-column gap-2 align-items-center">
                                <div class="btn-group" role="group">
                                    <a th:href="@{'/positions/' + ${position.id}}" class="btn btn-outline-primary btn-sm rounded-3" title="צפה">
                                        <i class="bi bi-eye"></i>
                                        נהל משרה
                                    </a>
                                </div>

                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="mb-5">
            <h4 class="mb-3">המשרות שהגשת אליהן</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>שם משרה</th>
                        <th>מיקום</th>
                        <th>סוג</th>
                        <th>תאריך הגשה</th>
                        <th>סטטוס</th>
                        <th>פעולות</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="app : ${applications}">
                        <td>
                            <a th:href="@{'/positions/' + ${app.position.id}}"
                               th:text="${app.position.jobTitle}"
                               class="text-decoration-none">
                            </a>
                        </td>
                        <td th:text="${app.position.location}"></td>
                        <td th:text="${app.position.assignmentType}"></td>
                        <td th:text="${#temporals.format(app.applicationDate, 'dd/MM/yyyy')}"></td>
                        <td>
                                <span class="badge"
                                      th:classappend="${app.status.name() == 'PENDING' ? 'bg-warning' : (app.status.name() == 'APPROVED' ? 'bg-success' : (app.status.name() == 'REJECTED' ? 'bg-danger' : 'bg-secondary'))}"
                                      th:text="${app.status.name() == 'PENDING' ? 'ממתין' : (app.status.name() == 'APPROVED' ? 'אושר' : (app.status.name() == 'REJECTED' ? 'נדחה' : 'בוטל'))}">
                                </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{'/positions/' + ${app.position.id}}"
                                   class="btn btn-outline-primary btn-sm rounded-3">
                                    <i class="bi bi-eye me-1"></i>
                                    צפה
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(applications)}">
                        <td colspan="6">לא נמצאו מועמדויות</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Unified Interviews Table -->
        <div>
            <h4 class="mb-3">ראיונות עתידיים</h4>
            <div class="table-responsive">
                <table class="table table-striped text-center align-middle" id="interviews-table">
                    <thead>
                    <tr>
                        <th>שם משרה</th>
                        <th th:if="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}">מועמד</th>
                        <th>תאריך
                            <a href="#" class="sort-link ms-1" data-sort="date" data-table="interviews-table" data-col="2">
                                <i class="bi bi-arrow-down-up"></i>
                            </a>
                        </th>
                        <th>שעה</th>
                        <th>מיקום / לינק</th>
                        <th>אישור הראיון</th>
                        <th>החלטה</th>
                        <th>הערות</th>
                        <th>תפקיד
                            <a href="#" class="sort-link ms-1" data-sort="role" data-table="interviews-table" data-col="8">
                                <i class="bi bi-arrow-down-up"></i>
                            </a>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(relevantInterviews)}">
                        <td colspan="8">אין ראיונות להצגה</td>
                    </tr>
                    <tr th:each="interview : ${relevantInterviews}">
                        <td th:text="${interview.application.position.jobTitle}"></td>
                        <td th:if="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}" th:text="${interview.application.applicant.firstName + ' ' + interview.application.applicant.lastName}"></td>
                        <td th:text="${#temporals.format(interview.interviewDate, 'dd/MM/yyyy')}"></td>
                        <td th:text="${#temporals.format(interview.interviewDate, 'HH:mm')}"></td>
                        <td>
                            <div th:if="${interview.isVirtual != null && interview.isVirtual}" class="text-center">
                                <a th:href="${interview.jitsiLink}" target="_blank" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-camera-video"></i> הצטרף לפגישה
                                </a>
                            </div>
                            <span th:if="${interview.isVirtual == null || !interview.isVirtual}" 
                                  th:text="${interview.location}"></span>
                        </td>
                        <td>
                            <span class="badge"
                                  th:classappend="${interview.status.name() == 'SCHEDULED' ? 'bg-warning' : (interview.status.name() == 'CONFIRMED' ? 'bg-success' : (interview.status.name() == 'REJECTED' ? 'bg-danger' : (interview.status.name() == 'COMPLETED' ? 'bg-primary' : 'bg-secondary')))}"
                                  th:text="${interview.status.name() == 'SCHEDULED' ? 'ממתין לאישור' : (interview.status.name() == 'CONFIRMED' ? 'מאושר' : (interview.status.name() == 'REJECTED' ? 'נדחה' : (interview.status.name() == 'COMPLETED' ? 'אושר' : 'מבוטל')))}">
                            </span>
                        </td>
                        <td>
                            <span th:if="${interview.application.applicant.username == #authentication.name}">
                                <span th:if="${interview.status.name() == 'COMPLETED'}" class="badge bg-success">התקבל</span>
                                <span th:if="${interview.status.name() == 'REJECTED' || interview.status.name() == 'CANCELED'}" class="badge bg-danger">נדחה</span>
                                <span th:if="${interview.status.name() != 'COMPLETED' && interview.status.name() != 'REJECTED' && interview.status.name() != 'CANCELED'}" class="badge bg-warning text-dark">ממתין</span>
                            </span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}">
                                <form th:action="@{'/interviews/' + ${interview.id} + '/decision'}" method="post" class="d-flex align-items-center gap-2 mb-0">
                                    <select name="decision" class="form-select form-select-sm">
                                        <option value="PENDING" th:selected="${interview.status.name() != 'COMPLETED' && interview.status.name() != 'REJECTED' && interview.status.name() != 'CANCELED'}">ממתין</option>
                                        <option value="COMPLETED" th:selected="${interview.status.name() == 'COMPLETED'}">התקבל</option>
                                        <option value="REJECTED" th:selected="${interview.status.name() == 'REJECTED' || interview.status.name() == 'CANCELED'}">נדחה</option>
                                    </select>
                                    <button type="submit" class="btn btn-outline-primary btn-sm">שמור</button>
                                </form>
                            </span>
                        </td>
                        <td th:text="${interview.notes}"></td>
                        <td>
                            <span th:if="${interview.application.applicant.username == #authentication.name}"
                                  class="badge bg-primary">מרואיין</span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}"
                                  class="badge bg-success">מראיין</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/toasts :: successToast}"></div>
<div th:replace="~{fragments/toasts :: errorToast}"></div>

<!-- Footer -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:src="@{/js/toasts.js}"></script>
<script th:src="@{/js/interviewsSort.js}"></script>
<script th:src="@{/js/interviewForm.js}"></script>
</body>
</html>