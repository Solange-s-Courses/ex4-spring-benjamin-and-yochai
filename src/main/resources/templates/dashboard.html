<!DOCTYPE html>
<html lang="he" dir="rtl" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: header}"></head>
<body class="d-flex flex-column min-vh-100">
<!-- Navigation -->
<nav th:replace="~{fragments/header :: navigation}"></nav>

<!-- Main Dashboard Section -->
<main class="flex-grow-1">
    <section class="container py-5 mt-4">
        <!-- Welcome -->
        <div class="mb-4 mt-4 d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">שלום <span sec:authentication="principal.firstName"></span>!</h2>
        </div>
        <!-- Statistics -->
        <div class="row mb-5 text-center">
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>סה"כ משרות שהוגשו</h5>
                    <p class="fs-4 fw-bold text-primary" th:text="${totalApplications}">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>ממתינות לקביעת ראיון</h5>
                    <p class="fs-4 fw-bold text-warning" th:text="${pendingApplications}">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>ראיונות קרובים</h5>
                    <p class="fs-4 fw-bold text-success" th:text="${upcomingInterviewCount}">0</p>
                </div>
            </div>
        </div>

        <!-- my positions -->
        <div sec:authorize="hasAnyRole('ADMIN', 'COMMANDER')" class="mb-5">
            <h4 class="mb-3">המשרות שפרסמת</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>שם משרה</th>
                        <th>מיקום</th>
                        <th>סוג</th>
                        <th>סטטוס</th>
                        <th>הגשות פעילות</th>
                        <th>פעולות</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(myPositions)}">
                        <td colspan="6">לא נמצאו משרות שפרסמת</td>
                    </tr>
                    <tr th:each="positionData : ${myPositions}">
                        <td>
                            <a th:href="@{'/positions/' + ${positionData.position.id}}"
                               th:text="${positionData.position.jobTitle}"
                               class="text-decoration-none">
                            </a>
                        </td>
                        <td th:text="${positionData.position.location}"></td>
                        <td th:text="${positionData.position.assignmentType}"></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${positionData.position.status.name() == 'ACTIVE' ? 'bg-success' :
                                  (positionData.position.status.name() == 'CANCELED' ? 'bg-danger' :
                                  (positionData.position.status.name() == 'FULFILLED' ? 'bg-primary' :
                                  (positionData.position.status.name() == 'FROZEN' ? 'bg-secondary' : 'bg-light')))}"
                                  th:text="${positionData.position.status.name() == 'ACTIVE' ? 'פעילה' :
                                  (positionData.position.status.name() == 'CANCELED' ? 'מבוטלת' :
                                  (positionData.position.status.name() == 'FULFILLED' ? 'אוישה' :
                                  (positionData.position.status.name() == 'FROZEN' ? 'מוקפאת' : positionData.position.status.name())))}">
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info" th:text="${positionData.activeApplications}">0</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-2 align-items-center">
                                <div class="btn-group" role="group">
                                    <a th:href="@{'/positions/' + ${positionData.position.id}}" class="btn btn-outline-primary btn-sm rounded-3" title="צפה">
                                        <i class="bi bi-eye"></i>
                                        נהל משרה
                                    </a>
                                </div>

                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="mb-5">
            <h4 class="mb-3">המשרות שהגשת אליהן</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>שם משרה</th>
                        <th>מיקום</th>
                        <th>סוג</th>
                        <th>תאריך הגשה</th>
                        <th>סטטוס</th>
                        <th>פעולות</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="app : ${applications}">
                        <td>
                            <a th:href="@{'/positions/' + ${app.position.id}}"
                               th:text="${app.position.jobTitle}"
                               class="text-decoration-none">
                            </a>
                        </td>
                        <td th:text="${app.position.location}"></td>
                        <td th:text="${app.position.assignmentType}"></td>
                        <td th:text="${#temporals.format(app.applicationDate, 'dd/MM/yyyy')}"></td>
                        <td>
                                <span class="badge"
                                      th:classappend="${app.status.name() == 'PENDING' ? 'bg-warning' : (app.status.name() == 'APPROVED' ? 'bg-success' : (app.status.name() == 'REJECTED' ? 'bg-danger' : 'bg-secondary'))}"
                                      th:text="${app.status.name() == 'PENDING' ? 'ממתין' : (app.status.name() == 'APPROVED' ? 'אושר' : (app.status.name() == 'REJECTED' ? 'נדחה' : 'בוטל'))}">
                                </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{'/positions/' + ${app.position.id}}"
                                   class="btn btn-outline-primary btn-sm rounded-3">
                                    <i class="bi bi-eye me-1"></i>
                                    צפה
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(applications)}">
                        <td colspan="6">לא נמצאו מועמדויות</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Unified Interviews Table -->
        <div>
            <h4 class="mb-3">ראיונות עתידיים</h4>
            <div class="table-responsive">
                <table class="table table-striped text-center align-middle" id="interviews-table">
                    <thead>
                    <tr>
                        <th>שם משרה</th>
                        <th th:if="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}">מועמד</th>
<!--                        <th>תאריך-->
<!--                            <a href="#" class="sort-link ms-1" data-sort="date" data-table="interviews-table" data-col="2">-->
<!--                                <i class="bi bi-arrow-down-up"></i>-->
<!--                            </a>-->
<!--                        </th>-->
                        <th>תאריך
                            <a href="#" class="sort-link ms-1" data-sort="date" data-table="interviews-table"
                               th:data-col="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')') ? '2' : '1'}">
                                <i class="bi bi-arrow-down-up"></i>
                            </a>
                        </th>
                        <th>שעה</th>
                        <th>מיקום / לינק</th>
                        <th>אישור הראיון</th>
                        <th>החלטה</th>
                        <th>הערות</th>
                        <th>תפקיד
                            <a href="#" class="sort-link ms-1" data-sort="role" data-table="interviews-table" data-col="8">
                                <i class="bi bi-arrow-down-up"></i>
                            </a>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(relevantInterviews)}">
                        <td colspan="8">אין ראיונות להצגה</td>
                    </tr>
                    <tr th:each="interview : ${relevantInterviews}">
                        <td th:text="${interview.application.position.jobTitle}"></td>
                        <td th:if="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}" th:text="${interview.application.applicant.firstName + ' ' + interview.application.applicant.lastName}"></td>
                        <td th:text="${#temporals.format(interview.interviewDate, 'dd/MM/yyyy')}"></td>
                        <td th:text="${#temporals.format(interview.interviewDate, 'HH:mm')}"></td>
                        <td>
                            <div th:if="${interview.isVirtual != null && interview.isVirtual}" class="text-center">
                                <a th:href="${interview.jitsiLink}" target="_blank" 
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-camera-video"></i> הצטרף לפגישה
                                </a>
                            </div>
                            <span th:if="${interview.isVirtual == null || !interview.isVirtual}" 
                                  th:text="${interview.location}"></span>
                        </td>
                        <td>
                            <span th:if="${interview.application.applicant.username == #authentication.name}">
                                <div th:if="${interview.status.name() == 'SCHEDULED'}" class="d-flex gap-2">
                                    <form th:action="@{'/interviews/' + ${interview.id} + '/confirm'}" method="post" class="mb-0">
                                        <button type="submit" class="btn btn-success btn-sm">אשר</button>
                                    </form>
                                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" th:data-bs-target="'#rejectModal' + ${interview.id}">דחה</button>
                                </div>
                                <span th:if="${interview.status.name() == 'CONFIRMED'}" class="badge bg-success">מאושר</span>
                                <span th:if="${interview.status.name() == 'REJECTED'}" class="badge bg-danger">נדחה</span>
                            </span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}">
                                <div>
                                    <span class="badge"
                                          th:classappend="${interview.status.name() == 'SCHEDULED' ? 'bg-warning' : (interview.status.name() == 'CONFIRMED' ? 'bg-success' : (interview.status.name() == 'REJECTED' ? 'bg-danger' : (interview.status.name() == 'COMPLETED' ? 'bg-primary' : 'bg-secondary')))}"
                                          th:text="${interview.status.name() == 'SCHEDULED' ? 'ממתין לאישור' : (interview.status.name() == 'CONFIRMED' ? 'מאושר' : (interview.status.name() == 'REJECTED' ? 'נדחה' : (interview.status.name() == 'COMPLETED' ? 'אושר' : 'מבוטל')))}">
                                    </span>
                                    <!-- הצגת סיבת הדחייה אם קיימת -->
                                    <div th:if="${interview.status.name() == 'REJECTED' && interview.rejectionReason != null && !#strings.isEmpty(interview.rejectionReason)}" 
                                         class="mt-1">
                                        <small class="text-muted">
                                            <strong>סיבה:</strong> <span th:text="${interview.rejectionReason}"></span>
                                        </small>
                                    </div>
                                </div>
                            </span>
                        </td>
                        <td>
                            <!-- עמודת החלטה - רק למפקד להחליט על תוצאת הראיון -->
                            <span th:if="${interview.application.applicant.username == #authentication.name}">
                                <!-- המועמד רואה את החלטת המפקד -->
                                <span th:if="${interview.status.name() == 'COMPLETED'}" class="badge bg-success">התקבל</span>
                                <span th:if="${interview.status.name() == 'CANCELED'}" class="badge bg-danger">נדחה</span>
                                <span th:if="${interview.status.name() != 'COMPLETED' && interview.status.name() != 'CANCELED'}" class="badge bg-warning text-dark">ממתין להחלטה</span>
                            </span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}">
                                <!-- המפקד יכול להחליט על התוצאה -->
                                <form th:action="@{'/interviews/' + ${interview.id} + '/decision'}" method="post" class="d-flex align-items-center gap-2 mb-0">
                                    <select name="decision" class="form-select form-select-sm">
                                        <option value="PENDING" th:selected="${interview.status.name() != 'COMPLETED' && interview.status.name() != 'CANCELED'}">ממתין להחלטה</option>
                                        <option value="COMPLETED" th:selected="${interview.status.name() == 'COMPLETED'}">התקבל</option>
                                        <option value="CANCELED" th:selected="${interview.status.name() == 'CANCELED'}">נדחה</option>
                                    </select>
                                    <button type="submit" class="btn btn-outline-primary btn-sm">שמור</button>
                                </form>
                            </span>
                        </td>
                        <td th:text="${interview.notes}"></td>
                        <td>
                            <span th:if="${interview.application.applicant.username == #authentication.name}"
                                  class="badge bg-primary">מרואיין</span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}"
                                  class="badge bg-success">מראיין</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<!-- Reject Interview Modals -->
<div th:each="interview : ${relevantInterviews}" th:if="${interview.application.applicant.username == #authentication.name && interview.status.name() == 'SCHEDULED'}">
    <div class="modal fade" th:id="'rejectModal' + ${interview.id}" tabindex="-1" aria-hidden="true" th:aria-labelledby="'rejectModalLabel' + ${interview.id}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" th:id="'rejectModalLabel' + ${interview.id}">דחיית ראיון</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{'/interviews/' + ${interview.id} + '/reject'}" method="post">
                    <div class="modal-body">
                        <p>האם אתה בטוח שברצונך לדחות את הראיון?</p>
                        <div class="mb-3">
                            <label th:for="'reason' + ${interview.id}" class="form-label">סיבת הדחייה (אופציונלי)</label>
                            <textarea class="form-control" th:id="'reason' + ${interview.id}" name="reason" rows="3" placeholder="הזן סיבה לדחיית הראיון..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                        <button type="submit" class="btn btn-danger">דחה ראיון</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/toasts :: successToast}"></div>
<div th:replace="~{fragments/toasts :: errorToast}"></div>

<!-- Footer -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:src="@{/js/toasts.js}"></script>
<script th:src="@{/js/interviewsSort.js}"></script>
<script th:src="@{/js/interviewForm.js}"></script>
</body>
</html>