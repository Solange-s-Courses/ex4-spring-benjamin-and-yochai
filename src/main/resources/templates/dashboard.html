<!DOCTYPE html>
<html lang="he" dir="rtl" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<head th:replace="~{fragments/header :: header}"></head>
<body class="d-flex flex-column min-vh-100">
<!-- Navigation -->
<nav th:replace="~{fragments/header :: navigation}"></nav>

<!-- Main Dashboard Section -->
<main class="flex-grow-1">
    <section class="container py-5 mt-4">
        <input type="hidden" id="username" th:value="${#authentication.name}">

        <!-- Welcome -->
        <div class="mb-4 mt-4 d-flex justify-content-between align-items-center">
            <h2 class="fw-bold">שלום <span sec:authentication="principal.firstName"></span>!</h2>
        </div>
        <!-- Statistics -->
        <div class="row mb-5 text-center">
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>סה"כ משרות שהוגשו</h5>
                    <p class="fs-4 fw-bold text-primary" id="totalApplicationsCount" th:text="${totalApplications}">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>ממתינות לקביעת ראיון</h5>
                    <p class="fs-4 fw-bold text-warning" id="pendingApplicationsCount" th:text="${pendingApplications}">0</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="border rounded-3 p-3 shadow-sm">
                    <h5>ראיונות קרובים</h5>
                    <p class="fs-4 fw-bold text-success" id="upcomingInterviewCount" th:text="${upcomingInterviewCount}">0</p>
                </div>
            </div>
        </div>

        <!-- my positions -->
        <div sec:authorize="hasAnyRole('ADMIN', 'COMMANDER')" class="mb-5">
            <h4 class="mb-3">המשרות שפרסמת</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>שם משרה</th>
                        <th>מיקום</th>
                        <th>סוג</th>
                        <th>סטטוס</th>
                        <th>הגשות פעילות</th>
                        <th>פעולות</th>
                    </tr>
                    </thead>
                    <tbody id="myPositionsTbody">
                    <tr th:classappend="${#lists.isEmpty(myPositions)?'':'d-none'}">
                        <td colspan="6">לא נמצאו משרות שפרסמת</td>
                    </tr>
                    <tr th:each="positionData : ${myPositions}" th:data-id="${positionData.position.id}">
                        <td>
                            <a th:href="@{'/positions/' + ${positionData.position.id}}"
                               th:text="${positionData.position.jobTitle}"
                               class="text-decoration-none">
                            </a>
                        </td>
                        <td th:text="${positionData.position.location}"></td>
                        <td th:text="${positionData.position.assignmentType}"></td>
                        <td>
                            <span class="badge"
                                  th:classappend="${positionData.position.status.name() == 'ACTIVE' ? 'bg-success' :
                                  (positionData.position.status.name() == 'CANCELED' ? 'bg-danger' :
                                  (positionData.position.status.name() == 'FULFILLED' ? 'bg-primary' :
                                  (positionData.position.status.name() == 'FROZEN' ? 'bg-secondary' : 'bg-light')))}"
                                  th:text="${positionData.position.status.name() == 'ACTIVE' ? 'פעילה' :
                                  (positionData.position.status.name() == 'CANCELED' ? 'מבוטלת' :
                                  (positionData.position.status.name() == 'FULFILLED' ? 'אוישה' :
                                  (positionData.position.status.name() == 'FROZEN' ? 'מוקפאת' : positionData.position.status.name())))}">
                            </span>
                        </td>
                        <td th:text="${positionData.activeApplications}"></td>
                        <td>
                            <div class="d-flex flex-column gap-2 align-items-center">
                                <div class="btn-group" role="group">
                                    <a th:href="@{'/positions/' + ${positionData.position.id}}" class="btn btn-outline-primary btn-sm rounded-3" title="צפה">
                                        <i class="bi bi-eye"></i>
                                        נהל משרה
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Applications Table -->
        <div class="mb-5">
            <h4 class="mb-3">המשרות שהגשת אליהן</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>שם משרה</th>
                        <th>מיקום</th>
                        <th>סוג</th>
                        <th>תאריך הגשה</th>
                        <th>סטטוס</th>
                        <th>פעולות</th>
                    </tr>
                    </thead>
                    <tbody id="myApplicationsTbody">
                    <tr th:each="app : ${applications}" th:data-id="${app.id}">
                        <td>
                            <a th:href="@{'/positions/' + ${app.position.id}}"
                               th:text="${app.position.jobTitle}"
                               class="text-decoration-none">
                            </a>
                        </td>
                        <td th:text="${app.position.location}"></td>
                        <td th:text="${app.position.assignmentType}"></td>
                        <td th:text="${#temporals.format(app.applicationDate, 'dd/MM/yyyy')}"></td>
                        <td>
                                <span class="badge"
                                      th:classappend="${app.status.name() == 'PENDING' ? 'bg-warning' : (app.status.name() == 'APPROVED' ? 'bg-success' : (app.status.name() == 'REJECTED' ? 'bg-danger' : 'bg-secondary'))}"
                                      th:text="${app.status.name() == 'PENDING' ? 'ממתין' : (app.status.name() == 'APPROVED' ? 'אושר' : (app.status.name() == 'REJECTED' ? 'נדחה' : 'בוטל'))}">
                                </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{'/positions/' + ${app.position.id}}"
                                   class="btn btn-outline-primary btn-sm rounded-3">
                                    <i class="bi bi-eye me-1"></i>
                                    צפה
                                </a>
                            </div>
                        </td>
                    </tr>
                    <tr th:classappend="${#lists.isEmpty(applications)?'':'d-none'}">
                        <td colspan="6">לא נמצאו מועמדויות</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Unified Interviews Table -->
        <div>
            <h4 class="mb-3">ראיונות עתידיים</h4>
            <div class="table-responsive">
                <table class="table table-striped text-center align-middle" id="interviews-table">
                    <thead>
                    <tr>
                        <th>שם משרה</th>
                        <th th:if="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}">מועמד</th>
                        <!--th th:unless="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}"> </th-->
                        <!--                        <th>תאריך-->
                        <!--                            <a href="#" class="sort-link ms-1" data-sort="date" data-table="interviews-table" data-col="2">-->
                        <!--                                <i class="bi bi-arrow-down-up"></i>-->
                        <!--                            </a>-->
                        <!--                        </th>-->
                        <th>תאריך
                            <a href="#" class="sort-link ms-1" data-sort="date" data-table="interviews-table"
                               th:data-col="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')') ? '2' : '1'}">
                                <i class="bi bi-arrow-down-up"></i>
                            </a>
                        </th>
                        <th>שעה</th>
                        <th>מיקום / לינק</th>
                        <th>אישור הראיון</th>
                        <th>הערות</th>
                        <th>תפקיד
                            <a href="#" class="sort-link ms-1" data-sort="role" data-table="interviews-table" data-col="8">
                                <i class="bi bi-arrow-down-up"></i>
                            </a>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="futureInterviewsTbody">
                    <tr th:classappend="${#lists.isEmpty(relevantInterviews)?'':'d-none'}">
                        <td colspan="7">אין ראיונות להצגה</td>
                    </tr>
                    <tr th:each="interview : ${relevantInterviews}" th:data-id="${interview.id}">
                        <td th:text="${interview.application.position.jobTitle}"></td>
                        <td th:if="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}"
                            th:text="${interview.application.applicant.firstName + ' ' + interview.application.applicant.lastName}"></td>
                        <!--td th:unless="${#authorization.expression('hasRole(''ADMIN'') or hasRole(''COMMANDER'')')}"> </td-->
                        <td th:text="${#temporals.format(interview.interviewDate, 'dd/MM/yyyy')}"></td>
                        <td th:text="${#temporals.format(interview.interviewDate, 'HH:mm')}"></td>
                        <td>
                            <div th:if="${interview.isVirtual != null && interview.isVirtual}" class="text-center">
                                <a th:href="${interview.jitsiLink}" target="_blank"
                                   class="btn btn-sm btn-primary">
                                    <i class="bi bi-camera-video"></i> הצטרף לפגישה
                                </a>
                            </div>
                            <span th:if="${interview.isVirtual == null || !interview.isVirtual}"
                                  th:text="${interview.location}"></span>
                        </td>
                        <td>
                                <span th:if="${interview.application.applicant.username == #authentication.name}">
                                    <div th:if="${interview.status.name() == 'SCHEDULED'}" class="d-flex gap-2">
                                        <form method="post" class="mb-0 confirm-interview-form" th:attr="data-interview-id=${interview.id}">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <button type="submit" class="btn btn-success btn-sm">אשר</button>
                                        </form>

                                        <button type="button" class="btn btn-danger btn-sm reject-interview-btn" th:attr="data-interview-id=${interview.id}">דחה</button>
                                    </div>
                                    <span th:if="${interview.status.name() == 'CONFIRMED'}"
                                          class="badge bg-success">מאושר</span>
                                    <span th:if="${interview.status.name() == 'REJECTED'}"
                                          class="badge bg-danger">נדחה</span>
                                </span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}">
                                    <div>
                                        <span class="badge"
                                              th:classappend="${interview.status.name() == 'SCHEDULED' ? 'bg-warning' : (interview.status.name() == 'CONFIRMED' ? 'bg-success' : (interview.status.name() == 'REJECTED' ? 'bg-danger' : (interview.status.name() == 'COMPLETED' ? 'bg-primary' : 'bg-secondary')))}"
                                              th:text="${interview.status.name() == 'SCHEDULED' ? 'ממתין לאישור' : (interview.status.name() == 'CONFIRMED' ? 'מאושר' : (interview.status.name() == 'REJECTED' ? 'נדחה' : (interview.status.name() == 'COMPLETED' ? 'אושר' : 'מבוטל')))}">
                                        </span>
                                        <!-- הצגת סיבת הדחייה אם קיימת -->
                                        <div th:if="${interview.status.name() == 'REJECTED' && interview.rejectionReason != null && !#strings.isEmpty(interview.rejectionReason)}"
                                             class="mt-1">
                                            <small class="text-muted">
                                                <strong>סיבה:</strong> <span th:text="${interview.rejectionReason}"></span>
                                            </small>
                                        </div>
                                    </div>
                                </span>
                        </td>
                        <td th:text="${interview.notes}"></td>
                        <td>
                                <span th:if="${interview.application.applicant.username == #authentication.name}"
                                      class="badge bg-primary">מרואיין</span>
                            <span th:if="${interview.application.applicant.username != #authentication.name}"
                                  class="badge bg-success">מראיין</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/toasts :: successToast}"></div>
<div th:replace="~{fragments/toasts :: errorToast}"></div>

<!-- Footer -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

<script th:src="@{/js/toasts.js}"></script>
<script th:src="@{/js/interviewsSort.js}"></script>
<script type="module" th:src="@{/js/interviewForm.js}"></script>
<script type="module" th:src="@{/js/dashboard.js}"></script>
</body>
</html>